#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üõ°Ô∏è  EJECUTANDO VALIDACIONES PRE-COMMIT..."

# 1. Verificar URLs hardcodeadas
echo "üîç Verificando URLs hardcodeadas..."
if grep -r "http://localhost:" --include="*.jsx" --include="*.js" --include="*.ts" --include="*.tsx" src/ manager.jsx 2>/dev/null; then
    echo "‚ùå COMMIT BLOQUEADO: Se encontraron URLs hardcodeadas"
    echo "üí° Usa getApiBase() en su lugar"
    echo "üí° Ejemplo: fetch(\`\${getApiBase()}/api/endpoint\`)"
    exit 1
fi

# 2. Verificar fetch sin getApiBase en nuevos archivos
echo "üîç Verificando fetch calls..."
if git diff --cached --name-only | xargs grep -l "fetch(" | xargs grep -H "fetch.*/" | grep -v "getApiBase\|https://api\." | grep -v "node_modules"; then
    echo "‚ö†Ô∏è  ADVERTENCIA: Se encontraron fetch calls que podr√≠an necesitar getApiBase()"
    echo "üí° Verifica que usen URLs din√°micas para compatibilidad con producci√≥n"
fi

# 3. Verificar que no se rompan funciones cr√≠ticas
echo "üîç Verificando funciones cr√≠ticas..."
CRITICAL_FUNCTIONS=(
    "handlePasteImage"
    "handleWysiwygPasteImage"
    "sendAssistantMessage"
    "authenticatedFetch"
)

for func in "${CRITICAL_FUNCTIONS[@]}"; do
    if ! grep -q "$func" manager.jsx 2>/dev/null; then
        echo "‚ö†Ô∏è  ADVERTENCIA: Funci√≥n cr√≠tica '$func' no encontrada"
    fi
done

# 4. Verificar estructura de archivos cr√≠ticos
echo "üîç Verificando archivos cr√≠ticos..."
CRITICAL_FILES=(
    "server.js"
    "manager.jsx"
    ".env.example"
)

for file in "${CRITICAL_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo "‚ùå COMMIT BLOQUEADO: Archivo cr√≠tico '$file' falta"
        exit 1
    fi
done

# 5. Verificar que existan endpoints cr√≠ticos en server.js
echo "üîç Verificando endpoints cr√≠ticos..."
CRITICAL_ENDPOINTS=(
    "/upload.php"
    "/api/assistant/response"
    "/api/auth"
)

for endpoint in "${CRITICAL_ENDPOINTS[@]}"; do
    if ! grep -q "$endpoint" server.js 2>/dev/null; then
        echo "‚ö†Ô∏è  ADVERTENCIA: Endpoint cr√≠tico '$endpoint' no encontrado en server.js"
    fi
done

echo "‚úÖ Validaciones pre-commit completadas"