name: ğŸš€ Auto Deploy to Production (Safe)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸ›¡ï¸ Safe Auto Deploy

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“‹ Install dependencies
      run: npm install

    - name: ğŸ§ª Run critical tests
      run: |
        echo "Running critical feature tests..."
        # Verificar que no hay URLs hardcodeadas
        if grep -r "http://localhost:" --include="*.jsx" --include="*.js" . 2>/dev/null; then
          echo "âŒ DEPLOY BLOCKED: Hardcoded URLs found"
          exit 1
        fi
        echo "âœ… No hardcoded URLs found"

        # Verificar funciones crÃ­ticas
        CRITICAL_FUNCTIONS=("handlePasteImage" "sendAssistantMessage" "getApiBase")
        for func in "${CRITICAL_FUNCTIONS[@]}"; do
          if ! grep -q "$func" manager.jsx 2>/dev/null; then
            echo "âŒ DEPLOY BLOCKED: Critical function '$func' missing"
            exit 1
          fi
        done
        echo "âœ… All critical functions present"

    - name: ğŸ” Deploy with SSH (Database Protection)
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e

          echo "ğŸ›¡ï¸ Starting SAFE auto-deploy..."
          cd ${{ secrets.PRODUCTION_PATH }}

          # 1. BACKUP OBLIGATORIO de base de datos
          echo "ğŸ’¾ Creating database backup..."
          if [ -f users.db ]; then
            timestamp=$(date +%Y%m%d_%H%M%S)
            cp users.db "backups/auto_deploy_${timestamp}.db"
            echo "âœ… Database backed up: backups/auto_deploy_${timestamp}.db"
          else
            echo "âš ï¸ No database found to backup"
          fi

          # 2. BACKUP de archivos crÃ­ticos
          echo "ğŸ“ Creating files backup..."
          mkdir -p backups/pre_deploy
          cp -f package.json backups/pre_deploy/ 2>/dev/null || true
          cp -f server.js backups/pre_deploy/ 2>/dev/null || true

          # 3. PROTEGER base de datos antes del pull
          echo "ğŸ”’ Protecting database..."
          if [ -f users.db ]; then
            mv users.db users.db.PROTECTED
            echo "âœ… Database protected"
          fi

          # 4. GIT PULL (ahora es seguro)
          echo "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main

          # 5. RESTAURAR base de datos
          echo "ğŸ”“ Restoring protected database..."
          if [ -f users.db.PROTECTED ]; then
            mv users.db.PROTECTED users.db
            echo "âœ… Database restored"
          fi

          # 6. INSTALAR dependencias si cambiÃ³ package.json
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production --silent

          # 7. VERIFICAR que todo estÃ¡ bien
          echo "ğŸ” Verifying deployment..."
          if [ ! -f users.db ]; then
            echo "âŒ CRITICAL: Database missing after deploy!"
            if [ -f "backups/auto_deploy_${timestamp}.db" ]; then
              echo "ğŸš¨ Restoring from backup..."
              cp "backups/auto_deploy_${timestamp}.db" users.db
              echo "âœ… Database restored from backup"
            fi
          fi

          if [ ! -f server.js ]; then
            echo "âŒ CRITICAL: server.js missing!"
            exit 1
          fi

          # 8. REINICIAR aplicaciÃ³n (PM2 si lo usas)
          echo "ğŸ”„ Restarting application..."
          # Descomenta segÃºn tu setup:
          # pm2 restart smartchatix || pm2 start server.js --name smartchatix
          # systemctl restart smartchatix
          # docker-compose restart

          echo "ğŸ‰ AUTO-DEPLOY COMPLETED SUCCESSFULLY!"
          echo "ğŸ’¾ Database: PROTECTED"
          echo "ğŸ“… Timestamp: $(date)"

          # 9. LIMPIAR backups antiguos (mantener Ãºltimos 10)
          echo "ğŸ§¹ Cleaning old backups..."
          cd backups
          ls -t auto_deploy_*.db 2>/dev/null | tail -n +11 | xargs rm -f || true

    - name: ğŸ” Post-deploy validation
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ” Validating deployment..."
          cd ${{ secrets.PRODUCTION_PATH }}

          # Verificar que la DB existe y no estÃ¡ vacÃ­a
          if [ -f users.db ]; then
            size=$(stat -c%s users.db)
            if [ $size -gt 0 ]; then
              echo "âœ… Database OK (${size} bytes)"
            else
              echo "âŒ Database is empty!"
              exit 1
            fi
          else
            echo "âŒ Database missing!"
            exit 1
          fi

          # Verificar archivos crÃ­ticos
          for file in server.js package.json; do
            if [ -f $file ]; then
              echo "âœ… $file present"
            else
              echo "âŒ $file missing!"
              exit 1
            fi
          done

          echo "ğŸ‰ VALIDATION COMPLETED - DEPLOY SUCCESS!"

    - name: ğŸ“± Notify success
      if: success()
      run: |
        echo "ğŸ‰ AUTO-DEPLOY SUCCESS!"
        echo "âœ… Database protected throughout process"
        echo "âœ… All validations passed"
        echo "ğŸŒ Production updated: https://app.smartchatix.com"